<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Voice Agent — Guarded v3 + Memory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { font-size: 28px; margin-bottom: 16px; }
    .card { background:#f2f2f2; padding:16px; border-radius:12px; margin:12px 0; }
    .row { margin: 10px 0; }
    input { width:100%; padding:12px; font-size:16px; border-radius:10px; border:1px solid #ccc; }
    button { padding:12px 16px; border-radius:12px; border:0; background:#e6e6e6; font-size:18px; margin:6px 8px 6px 0; }
    .ok { color: #0a8a00; font-weight:600; margin-left:8px; }
    .err { color: #b00020; font-weight:600; margin-left:8px; }
    pre { white-space: pre-wrap; background:#fafafa; padding:12px; border-radius:12px; border:1px solid #eee; }
    small.mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    ul { padding-left: 18px; }
    li { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>Voice Agent — Guarded v3 + Memory</h1>

  <div class="card">
    <div class="row"><b>Your Memory (saved to server)</b></div>
    <div class="row"><small class="mono">User ID: <span id="uid"></span></small>
      <button id="copyUid">Copy</button></div>

    <div class="row"><b>Name:</b></div>
    <div class="row"><input id="name" placeholder="e.g., Alex Smith" /></div>
    <div class="row">
      <button id="saveName">Save</button><span id="saveNameStat"></span>
    </div>

    <div class="row"><b>Kids:</b></div>
    <div class="row"><input id="kids" placeholder="Comma-separated: Ava, Ben, Chris" /></div>
    <div class="row">
      <button id="saveKids">Save</button><span id="saveKidsStat"></span>
    </div>

    <div class="row"><b>Tone:</b></div>
    <div class="row"><input id="tone" placeholder="e.g., witty, concise, encouraging" /></div>
    <div class="row">
      <button id="saveTone">Save</button><span id="saveToneStat"></span>
    </div>

    <div class="row"><b>Persona:</b></div>
    <div class="row"><input id="persona" placeholder="e.g., friendly coach, upbeat coworker" /></div>
    <div class="row">
      <button id="savePersona">Save</button><span id="savePersonaStat"></span>
    </div>

    <div class="row"><b>Add note:</b></div>
    <div class="row"><input id="note" placeholder="Any fact you want Dummy to remember" /></div>
    <div class="row">
      <button id="addNote">Add</button><span id="addNoteStat"></span>
    </div>

    <div class="row"><b>Notes:</b></div>
    <div class="row"><ul id="notesList"></ul></div>
  </div>

  <div class="row">
    <button id="beep1">Beep (WebAudio)</button>
    <button id="beep2">Beep (AudioTag)</button>
  </div>

  <div class="row">
    <button id="nudge">Nudge audio</button>
    <button id="unlock">Unlock mic</button>
  </div>

  <div class="row">
    <button id="start">Start voice agent</button>
    <button id="stop" disabled>Stop</button>
  </div>

  <div class="row">
    <button id="force" disabled>Force reply</button>
  </div>

  <div class="row"><b>Status:</b> <span id="status">idle</span></div>
  <pre id="log"></pre>

<script>
const $ = (id) => document.getElementById(id);
const log = (s) => { $("log").textContent += (s + "\n"); $("log").scrollTop = $("log").scrollHeight; };
const setStatus = (s) => $("status").textContent = s;

function getUserId() {
  let id = localStorage.getItem("dummy_user_id");
  if (!id) { id = crypto.randomUUID(); localStorage.setItem("dummy_user_id", id); }
  return id;
}
const userId = getUserId();
$("uid").textContent = userId;
$("copyUid").onclick = () => navigator.clipboard.writeText(userId);

const statOk = (el)=>{ el.className="ok"; el.textContent="Saved ✓"; setTimeout(()=>{el.textContent="";},2000); };
const statErr= (el)=>{ el.className="err"; el.textContent="Failed"; setTimeout(()=>{el.textContent="";},3000); };

// ------- Memory UI -------
async function loadMemory() {
  try {
    const r = await fetch(`/memory/get?userId=${encodeURIComponent(userId)}`);
    const j = await r.json();
    const m = j.memory || {};
    $("name").value    = m.name    || "";
    $("kids").value    = m.kids    || "";
    $("tone").value    = m.tone    || "";
    $("persona").value = m.persona || "";
  } catch {}
}
async function listNotes() {
  const r = await fetch(`/memory/notes/list?userId=${encodeURIComponent(userId)}`);
  const j = await r.json();
  const ul = $("notesList");
  ul.innerHTML = "";
  (j.notes || []).forEach(t => {
    const li = document.createElement("li");
    li.textContent = t;
    ul.appendChild(li);
  });
}
async function setMem(key, value, statEl) {
  try {
    const r = await fetch(`/memory/set?userId=${encodeURIComponent(userId)}&key=${encodeURIComponent(key)}&value=${encodeURIComponent(value)}`);
    const j = await r.json();
    if (j.ok) statOk(statEl); else statErr(statEl);
  } catch { statErr(statEl); }
}
$("saveName").onclick    = () => setMem("name", $("name").value.trim(), $("saveNameStat"));
$("saveKids").onclick    = () => setMem("kids", $("kids").value.trim(), $("saveKidsStat"));
$("saveTone").onclick    = () => setMem("tone", $("tone").value.trim(), $("saveToneStat"));
$("savePersona").onclick = () => setMem("persona", $("persona").value.trim(), $("savePersonaStat"));
$("addNote").onclick     = async () => {
  const text = $("note").value.trim();
  if (!text) return;
  try {
    const r = await fetch("/memory/notes/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, text })
    });
    const j = await r.json();
    if (j.ok) { statOk($("addNoteStat")); $("note").value = ""; listNotes(); }
    else statErr($("addNoteStat"));
  } catch { statErr($("addNoteStat")); }
};

// ------- Audio helpers -------
$("beep1").onclick = () => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator(); o.frequency.value = 880;
  const g = ctx.createGain(); g.gain.value = 0.05; o.connect(g); g.connect(ctx.destination);
  o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 160);
  log("WebAudio beep");
};
$("beep2").onclick = () => {
  const a = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA"); // tiny silent blip
  a.play(); log("AudioTag beep");
};
$("nudge").onclick = () => $("beep1").click();

// ------- Realtime (WebRTC) -------
let pc, dc, stream;

$("unlock").onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    log("microphone OK");
  } catch (e) { log("mic error: " + e); }
};

$("start").onclick = async () => {
  setStatus("starting…"); $("force").disabled = true; $("stop").disabled = false;

  try {
    // Ensure mic stream
    if (!stream) stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // Get ephemeral token + personalized instructions
    log("start: step 3/7 fetch /session");
    const sres = await fetch(`/session?userId=${encodeURIComponent(userId)}`);
    const session = await sres.json();
    log("start: got session");

    // Create PeerConnection
    log("start: step 5/7 create RTCPeerConnection");
    pc = new RTCPeerConnection();
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    // Data channel for “force reply”
    dc = pc.createDataChannel("oai-events");
    dc.onopen = () => { $("force").disabled = false; log("datachannel open"); };
    dc.onclose = () => { $("force").disabled = true; log("datachannel closed"); };

    pc.oniceconnectionstatechange = () => log(`pc state: ${pc.iceConnectionState}`);
    pc.onconnectionstatechange = () => log(`ice state: ${pc.connectionState}`);

    log("start: step 6/7 createOffer & setLocalDescription");
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // Send offer to OpenAI Realtime, auth with client_secret
    log("start: step 7/7 POST offer to OpenAI");
    const base = session.client_secret.value; // ephemeral key
    const r = await fetch("https://api.openai.com/v1/realtime?model=" + encodeURIComponent(session.model), {
      method: "POST",
      headers: { Authorization: `Bearer ${base}`, "Content-Type": "application/sdp" },
      body: offer.sdp
    });

    const answer = { type: "answer", sdp: await r.text() };
    await pc.setRemoteDescription(answer);

    setStatus("listening");
    log("connected ✓ (speak, or tap Force reply)");
  } catch (e) {
    setStatus("idle"); $("force").disabled = true; $("stop").disabled = true;
    log("start error: " + e);
  }
};

$("force").onclick = () => {
  try {
    if (dc && dc.readyState === "open") {
      dc.send(JSON.stringify({ type: "response.create" }));
      log("forced reply");
    }
  } catch (e) { log("force error: " + e); }
};

$("stop").onclick = () => {
  try {
    if (dc) dc.close();
    if (pc) pc.close();
    dc = null; pc = null;
    setStatus("idle");
  } catch {}
};

loadMemory(); listNotes();
</script>
</body>
</html>
