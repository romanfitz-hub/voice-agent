<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Voice Agent — Memory + Realtime (Penn State theme)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ========= Penn State themed Clean & Airy =========
       Primary navy: #041E42 (Penn State Blue)
    */
    * { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
    :root{
      --bg:#fafafa;
      --surface:#ffffff;
      --ink:#0b0b0b;
      --muted:#656565;
      --line:#e7e9ee;

      --accent:#041E42;      /* Penn State Blue */
      --accentSoft:#e9eef6;  /* light blue chip */
      --accentText:#0b3d91;  /* deep blue for chips */
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --radius:14px;
    }
    body{
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin:0; color:var(--ink); background:var(--bg);
    }

    header{
      padding:22px;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(950px 320px at 12% -40%, rgba(4,30,66,.10) 0%, rgba(4,30,66,0) 60%),
        var(--surface);
      position: sticky; top: 0; z-index: 5;
    }
    h1{ font-size:22px; display:flex; align-items:center; gap:10px; margin:0 0 6px; }
    .sub{ color:var(--muted); font-size:13px; }

    .logo{ width:22px; height:22px; display:inline-block; color:var(--accent); }
    .logo svg{ display:block; width:100%; height:100%; }

    main{
      max-width:1100px; margin:0 auto; padding:18px;
      display:grid; gap:18px; grid-template-columns:minmax(0,1fr) 360px;
    }
    @media (max-width: 900px){ main{ grid-template-columns:1fr; } }

    .panel{ min-width:0; }
    .card{
      background:var(--surface); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
    }
    .row{ margin:10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input{
      flex:1; min-width:220px; padding:12px; font-size:16px;
      border-radius:12px; border:1px solid var(--line); background:#fff;
    }
    button{
      padding:12px 16px; border-radius:12px; border:1px solid var(--line);
      background:#fff; font-size:15px; cursor:pointer; transition:.15s ease;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.08); }
    button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    button.primary:hover{ box-shadow:0 8px 16px rgba(4,30,66,.22); }
    button.warn{ background:#fff6f6; border-color:#ffd9d9; }

    .pill{
      font-size:12px; padding:4px 10px; border-radius:999px;
      background:var(--accentSoft); color:var(--accentText);
      border:1px solid #d6dfec;
    }
    .k{
      padding:2px 6px; border-radius:8px; background:#f5f7fa; border:1px solid var(--line);
      font-family:ui-monospace, Menlo, Consolas, monospace;
    }

    pre{
      white-space:pre-wrap; background:#fcfcfc; padding:12px; border-radius:12px;
      border:1px solid var(--line); max-height:34vh; overflow:auto; margin:0;
      overflow-wrap:anywhere; word-break:break-word;
    }

    #notesList{ max-height:60vh; overflow:auto; }
    .note{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:10px 0; }
    .note small{ color:#7b7b7b; display:block; margin-top:6px; }
    .notesHead{ display:flex; align-items:center; justify-content:space-between; margin-top:6px; }

    @media (max-width:520px){
      .row{ flex-direction:column; align-items:stretch; }
      input,button{ width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <span class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
          <path d="M8 13.5c2.2 1.8 5.8 1.8 8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="9" cy="10" r="1" fill="currentColor"/><circle cx="15" cy="10" r="1" fill="currentColor"/>
        </svg>
      </span>
      Voice Agent — Memory + Realtime
    </h1>
    <div class="sub">
      Say <span class="k">remember: …</span>. The model will say a line with <span class="k">SAVE_NOTE: …</span> — we’ll save it as a Note.
      Use <span class="k">Force reply</span> if it goes quiet. On <span class="k">Stop</span>, we save a 3-bullet call snapshot.
    </div>
  </header>

  <main>
    <!-- LEFT: Core controls + Profile memory + Logs -->
    <section class="panel">
      <div class="card">
        <div class="row"><b>Your Memory (saved to server)</b></div>
        <div class="row">
          <small class="mono">User ID: <span id="uid"></span></small>
          <button id="copyUid">Copy</button>
          <span class="pill" id="status">idle</span>
        </div>

        <div class="row"><b>Name:</b><input id="name" placeholder="e.g., Roman" /><button id="saveName">Save</button><span id="saveNameStat"></span></div>
        <div class="row"><b>Kids:</b><input id="kids" placeholder="Comma-separated: Ava, Ben, Chris" /><button id="saveKids">Save</button><span id="saveKidsStat"></span></div>
        <div class="row"><b>Tone:</b><input id="tone" placeholder="e.g., witty, concise, encouraging" /><button id="saveTone">Save</button><span id="saveToneStat"></span></div>
        <div class="row"><b>Persona:</b><input id="persona" placeholder="e.g., friendly coach, upbeat coworker" /><button id="savePersona">Save</button><span id="savePersonaStat"></span></div>
      </div>

      <div class="row">
        <button id="beep1">Beep (WebAudio)</button>
        <button id="beep2">Beep (AudioTag)</button>
        <button id="unlock">Unlock mic</button>
      </div>

      <div class="row">
        <button id="start" class="primary">Start voice agent</button>
        <button id="force" disabled>Force reply</button>
        <button id="stop" class="warn" disabled>Stop</button>
      </div>

      <div class="card">
        <b>Log</b>
        <pre id="log"></pre>
      </div>

      <!-- IMPORTANT: this plays the remote audio -->
      <audio id="remoteAudio" autoplay playsinline></audio>
    </section>

    <!-- RIGHT: Notes panel -->
    <aside class="panel">
      <div class="card">
        <div class="notesHead">
          <b>Notes</b>
          <div>
            <button id="refreshNotes">Refresh</button>
            <button id="clearNotes">Clear All</button>
          </div>
        </div>
        <div id="notesList"><div class="sub">No notes yet…</div></div>
        <div class="sub" style="margin-top:8px">
          Examples: <span class="k">remember: order more cups</span>, <span class="k">remember: greet Roman by name</span>.
        </div>
      </div>
    </aside>
  </main>

<script>
/* ========= helpers ========= */
const $ = (id) => document.getElementById(id);
const log = (s) => { $("log").textContent += (s + "\n"); $("log").scrollTop = $("log").scrollHeight; };
const setStatus = (s) => $("status").textContent = s;

/* ✅ FIXED: correct escaping map (the previous version had a bad quote) */
const escapeHtml = (s) =>
  String(s).replace(/[&<>\"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[m]));

// Stable userId (localStorage) — keeps your memory consistent
function getUserId() {
  let id = localStorage.getItem("dummy_user_id");
  if (!id) { id = crypto.randomUUID(); localStorage.setItem("dummy_user_id", id); }
  return id;
}
const userId = getUserId();
$("uid").textContent = userId;
$("copyUid").onclick = () => navigator.clipboard.writeText(userId);

/* ========= Profile memory UI ========= */
async function loadProfileMemory() {
  try {
    const r = await fetch(`/memory/get?userId=${encodeURIComponent(userId)}`);
    const j = await r.json();
    const m = j.memory || {};
    $("name").value    = m.name    || "";
    $("kids").value    = m.kids    || "";
    $("tone").value    = m.tone    || "";
    $("persona").value = m.persona || "";
  } catch (e) { log("loadProfileMemory error: " + e); }
}
async function setMem(key, value, el) {
  try {
    const r = await fetch(`/memory/set?userId=${encodeURIComponent(userId)}&key=${encodeURIComponent(key)}&value=${encodeURIComponent(value)}`);
    const j = await r.json();
    el.className = j.ok ? "ok" : "err";
    el.textContent = j.ok ? "Saved ✓" : "Failed";
    setTimeout(()=>{ el.textContent = ""; el.className=""; }, 2000);
  } catch { el.className="err"; el.textContent="Failed"; }
}
$("saveName").onclick    = () => setMem("name", $("name").value.trim(), $("saveNameStat"));
$("saveKids").onclick    = () => setMem("kids", $("kids").value.trim(), $("saveKidsStat"));
$("saveTone").onclick    = () => setMem("tone", $("tone").value.trim(), $("saveToneStat"));
$("savePersona").onclick = () => setMem("persona", $("persona").value.trim(), $("savePersonaStat"));

/* ========= Notes panel ========= */
const notesState = { items: [] };
let lastSavedNote = ""; // dedupe protection

function renderNotes() {
  const box = $("notesList");
  if (!notesState.items.length) { box.innerHTML = `<div class="sub">No notes yet…</div>`; return; }
  box.innerHTML = notesState.items.map(text => `
    <div class="note">
      <div>${escapeHtml(text)}</div>
      <small>${new Date().toLocaleString()}</small>
    </div>`).join('');
}
async function loadNotes() {
  try {
    const r = await fetch(`/memory/notes/list?userId=${encodeURIComponent(userId)}`);
    const j = await r.json();
    notesState.items = Array.isArray(j.notes) ? j.notes : [];
    renderNotes();
  } catch (e) { log('notes load error: ' + e); }
}
async function addNote(text) {
  const note = String(text || "").trim();
  if (!note || note === lastSavedNote) return;
  try {
    const r = await fetch(`/memory/notes/add`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, text: note })
    });
    if (!r.ok) throw new Error('notes add failed');
    lastSavedNote = note;
    await loadNotes();
    log('NOTE saved: ' + note);
  } catch (e) { log('notes add error: ' + e); }
}
/* NOTE: Clear All calls a route that may not exist in your current server.
   If it 404s, you can ignore the button or we can wire a /memory/notes/clear later. */
async function clearNotes() {
  try {
    const r = await fetch(`/memory/notes/clear`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId })
    });
    if (!r.ok) throw new Error('notes clear failed');
    notesState.items = []; lastSavedNote = "";
    renderNotes();
    log('notes cleared');
  } catch (e) { log('notes clear error: ' + e); }
}
$("refreshNotes").onclick = () => loadNotes();
$("clearNotes").onclick = () => { if (confirm('Clear all notes?')) clearNotes(); };

/* ========= Audio nudges ========= */
$("beep1").onclick = () => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator(); const g = ctx.createGain();
  osc.frequency.value = 880; g.gain.value = 0.06;
  osc.connect(g).connect(ctx.destination); osc.start();
  setTimeout(()=>{ osc.stop(); ctx.close(); }, 150);
  log("WebAudio beep");
};
$("beep2").onclick = () => {
  const a = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA");
  a.play(); log("AudioTag beep");
};

/* ========= Realtime (WebRTC) ========= */
let pc, dc, micStream;
const remoteAudio = $("remoteAudio");

// Transcript buffer for end-of-call summary (assistant lines)
const transcript = []; // {role:'assistant', text, t}

$("unlock").onclick = async () => {
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    log("microphone OK");
  } catch (e) { log("mic error: " + e); }
};

$("start").onclick = async () => {
  setStatus("starting…"); $("force").disabled = true; $("stop").disabled = false;

  try {
    if (!micStream) micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // 1) Get ephemeral client_secret + personalized instructions
    log("start: step 3/7 fetch /session");
    const sres = await fetch(`/session?userId=${encodeURIComponent(userId)}`);
    const session = await sres.json();
    if (!session?.client_secret?.value) throw new Error("No client_secret in /session");
    log("start: got session");

    // 2) RTCPeerConnection
    log("start: step 5/7 create RTCPeerConnection");
    pc = new RTCPeerConnection();

    // attach remote audio
    pc.ontrack = (ev) => {
      remoteAudio.srcObject = ev.streams[0];
      log("ontrack: remote audio attached");
    };

    // data channel
    dc = pc.createDataChannel("oai-events");
    dc.onopen = () => { $("force").disabled = false; log("datachannel open"); };

    // === Handle realtime events ===
    dc.onmessage = (e) => {
      let data = e.data;
      try { data = JSON.parse(e.data); } catch { /* sometimes plain text */ }

      // AUDIO transcript deltas (spoken assistant) - ignore; we save on 'done'
      if (data && data.type === 'response.audio_transcript.delta' && typeof data.delta === 'string') {
        return;
      }

      // AUDIO transcript done -> capture text, save notes, add to summary buffer
      if (data && data.type === 'response.audio_transcript.done' && typeof data.transcript === 'string') {
        const full = data.transcript.trim();
        if (full) {
          transcript.push({ role:'assistant', text: full, t: Date.now() });
          log("assistant: " + full.slice(0, 500));
          handleSaveNotesFrom(full);
        }
        return;
      }

      // TEXT deltas (if model ever streams text modality)
      if (data && data.type === 'response.output_text.delta' && typeof data.delta === 'string') {
        return;
      }

      // Log short
      const raw = typeof e.data === 'string' ? e.data : JSON.stringify(e.data);
      log("event: " + raw.slice(0, 300));
    };

    // send mic
    micStream.getTracks().forEach(t => pc.addTrack(t, micStream));

    // 3) Offer → OpenAI
    log("start: step 6/7 createOffer & setLocalDescription");
    const offer = await pc.createOffer({ offerToReceiveAudio: true });
    await pc.setLocalDescription(offer);

    log("start: step 7/7 POST offer to OpenAI");
    const resp = await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(session.model)}&voice=verse`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${session.client_secret.value}`,
        "Content-Type": "application/sdp"
      },
      body: offer.sdp
    });

    const answer = { type: "answer", sdp: await resp.text() };
    await pc.setRemoteDescription(answer);

    pc.oniceconnectionstatechange = () => log("pc state: " + pc.iceConnectionState);
    pc.onconnectionstatechange = () => log("ice state: " + pc.connectionState);

    setStatus("listening");
    log("connected ✓ (speak, or tap Force reply)");
  } catch (e) {
    setStatus("idle"); $("force").disabled = true; $("stop").disabled = true;
    log("start error: " + e);
  }
};

// Parse SAVE_NOTE lines only when a full transcript chunk completes
function handleSaveNotesFrom(text) {
  const matches = String(text).match(/SAVE_NOTE:\s*([^\n\r]+)/gi) || [];
  for (const m of matches) {
    const cleaned = m.replace(/^SAVE_NOTE:\s*/i, "").trim();
    if (cleaned) addNote(cleaned);
  }
}

$("force").onclick = () => {
  try {
    if (!dc || dc.readyState !== "open") { log("force: datachannel not open"); return; }
    const name = $("name").value.trim();
    const greet = name ? `Say: Hello ${name}. I can hear you.` : "Say: Hello. I can hear you.";
    dc.send(JSON.stringify({ type: "response.create", response: { modalities: ["audio"], instructions: greet } }));
    log("force: sent response.create");
  } catch (e) { log("force error: " + e); }
};

$("stop").onclick = async () => {
  try {
    setStatus("stopping…");

    // End-of-call snapshot (optional; will 404 if /summarize isn't on your server)
    try {
      const r = await fetch('/summarize', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId, transcript })
      });
      const j = await r.json();
      const summary = (j && j.summary) ? String(j.summary).trim() : '';
      if (summary) await addNote(summary);
    } catch (e) {
      log('snapshot failed (ok to ignore): ' + e);
    }

    if (dc) dc.close();
    if (pc) pc.close();
    dc = null; pc = null;
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    remoteAudio.srcObject = null;
    $("force").disabled = true; $("stop").disabled = true;
    setStatus("idle");
    log("stopped");
  } catch {}
};

// Boot
loadProfileMemory();
loadNotes();
</script>
</body>
</html>
