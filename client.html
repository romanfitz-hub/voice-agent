<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voice Agent — Guarded v3 + Memory</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; padding: 16px; line-height: 1.4; }
    h1 { margin: 0 0 16px; }
    .card { background: #f3f3f3; padding: 14px; border-radius: 12px; margin-bottom: 16px; }
    label { display:block; font-weight: 600; margin: 14px 0 6px; }
    input { width:100%; font-size:17px; padding:10px 12px; border:1px solid #bbb; border-radius:10px; }
    button { font-size:17px; padding:10px 14px; border-radius:12px; border:0; background:#e6e6e6; margin-top:10px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin: 8px 0 0; }
    .ok { color:#0a7a0a; margin-left:8px; font-weight:600; }
    pre { white-space:pre-wrap; word-break:break-word; background:#fafafa; padding:10px; border-radius:10px; border:1px solid #eee; }
  </style>
</head>
<body>
  <h1>Voice Agent — Guarded v3 + Memory</h1>

  <div class="card">
    <div>Your Memory (saved to server)</div>
    <div style="font-size:13px; opacity:.8; margin-top:6px;">
      User ID: <span id="uid"></span>
      <button id="copyId" style="margin-left:8px;">Copy</button>
    </div>

    <label for="name">Name:</label>
    <input id="name" placeholder="e.g., Alex Smith" />
    <div class="row">
      <button id="saveName">Save</button><span id="savedName" class="ok"></span>
    </div>

    <label for="kids">Kids:</label>
    <input id="kids" placeholder="Comma-separated: Ava, Ben, Chris" />
    <div class="row">
      <button id="saveKids">Save</button><span id="savedKids" class="ok"></span>
    </div>

    <label for="tone">Tone:</label>
    <input id="tone" placeholder="e.g., witty, concise, encouraging" />
    <div class="row">
      <button id="saveTone">Save</button><span id="savedTone" class="ok"></span>
    </div>

    <label for="persona">Persona:</label>
    <input id="persona" placeholder="e.g., friendly coach, upbeat coworker" />
    <div class="row">
      <button id="savePersona">Save</button><span id="savedPersona" class="ok"></span>
    </div>

    <p style="font-size:13px; opacity:.8; margin-top:10px;">
      These are included in Dummy’s session so it can greet you by name, remember family, and keep your tone/persona.
    </p>
  </div>

  <div class="row">
    <button id="beepWA">Beep (WebAudio)</button>
    <button id="beepAT">Beep (AudioTag)</button>
    <button id="nudge">Nudge audio</button>
    <button id="unlock">Unlock mic</button>
  </div>
  <div class="row">
    <button id="start">Start voice agent</button>
    <button id="stop" disabled>Stop</button>
    <button id="force" disabled>Force reply</button>
  </div>

  <div style="margin-top:10px;">Status: <b id="status">idle</b></div>
  <pre id="log"></pre>

<script>
(function () {
  // ---------- simple logger ----------
  const log = (m) => { const el = document.getElementById('log'); el.textContent += (el.textContent ? "\n" : "") + m; el.scrollTop = el.scrollHeight; };

  // ---------- stable userId per browser ----------
  const uidEl = document.getElementById('uid');
  let userId = localStorage.getItem('dummy_user_id');
  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem('dummy_user_id', userId);
  }
  uidEl.textContent = userId;
  document.getElementById('copyId').onclick = () => navigator.clipboard.writeText(userId);

  // ---------- memory helpers ----------
  async function memGet() {
    const res = await fetch(`/memory/get?userId=${encodeURIComponent(userId)}`);
    return await res.json(); // { ok:true, memory:{...} }
  }
  async function memSet(key, value) {
    // use POST (primary)
    const res = await fetch('/memory/set', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ userId, key, value })
    });
    return await res.json(); // { ok:true, saved:true }
  }

  // load memory on page load
  (async () => {
    try {
      const data = await memGet();
      const m = data.memory || {};
      if (m.name)    document.getElementById('name').value = m.name;
      if (m.kids)    document.getElementById('kids').value = m.kids;
      if (m.tone)    document.getElementById('tone').value = m.tone;
      if (m.persona) document.getElementById('persona').value = m.persona;
    } catch (e) { console.error(e); }
  })();

  // wire up save buttons
  document.getElementById('saveName').onclick = async () => {
    const v = document.getElementById('name').value.trim();
    const r = await memSet('name', v);
    document.getElementById('savedName').textContent = r.saved ? 'Saved ✓' : 'Failed';
    setTimeout(()=>document.getElementById('savedName').textContent='', 2000);
  };
  document.getElementById('saveKids').onclick = async () => {
    const v = document.getElementById('kids').value.trim();
    const r = await memSet('kids', v);
    document.getElementById('savedKids').textContent = r.saved ? 'Saved ✓' : 'Failed';
    setTimeout(()=>document.getElementById('savedKids').textContent='', 2000);
  };
  document.getElementById('saveTone').onclick = async () => {
    const v = document.getElementById('tone').value.trim();
    const r = await memSet('tone', v);
    document.getElementById('savedTone').textContent = r.saved ? 'Saved ✓' : 'Failed';
    setTimeout(()=>document.getElementById('savedTone').textContent='', 2000);
  };
  document.getElementById('savePersona').onclick = async () => {
    const v = document.getElementById('persona').value.trim();
    const r = await memSet('persona', v);
    document.getElementById('savedPersona').textContent = r.saved ? 'Saved ✓' : 'Failed';
    setTimeout(()=>document.getElementById('savedPersona').textContent='', 2000);
  };

  // ---- the rest is your existing agent code (beep/nudge/start...) ----
  const statusEl = document.getElementById('status');
  function setStatus(s){ statusEl.textContent = s; }

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const beep = () => { const o=ctx.createOscillator(); const g=ctx.createGain(); o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2); setTimeout(()=>o.stop(),220);},120); };
  document.getElementById('beepWA').onclick = () => { if (ctx.state==='suspended') ctx.resume(); beep(); log('WebAudio beep'); };
  document.getElementById('beepAT').onclick = () => { const a=new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAA=='); a.play(); log('AudioTag beep'); };
  document.getElementById('nudge').onclick = () => { if (ctx.state==='suspended') ctx.resume(); beep(); log('WebAudio nudge OK'); };
  document.getElementById('unlock').onclick = async () => { await navigator.mediaDevices.getUserMedia({audio:true}); log('microphone OK'); };

  let pc, dc, micStream, micTrack;
  document.getElementById('start').onclick = async () => {
    try {
      setStatus('preparing...');
      if (ctx.state==='suspended') await ctx.resume();
      beep(); log('start: step 1/7 nudge audio');

      log('start: step 2/7 unlock mic');
      micStream = await navigator.mediaDevices.getUserMedia({audio:true}); log('microphone OK');

      log('start: step 3/7 fetch /session');
      const session = await fetch('/session').then(r=>r.json()); // your server should already support this from earlier work
      log('start: got session');

      log('start: step 4/7 getUserMedia real');
      micTrack = micStream.getTracks()[0];

      log('start: step 5/7 create RTCPeerConnection');
      pc = new RTCPeerConnection();
      pc.addTrack(micTrack, micStream);
      dc = pc.createDataChannel('oai');
      dc.onopen = ()=>log('datachannel open');

      pc.oniceconnectionstatechange = ()=>log('ice state: '+pc.iceConnectionState);
      pc.onconnectionstatechange   = ()=>log('pc state: '+pc.connectionState);

      log('start: step 6/7 createOffer & setLocalDescription');
      const offer = await pc.createOffer({offerToReceiveAudio:true});
      await pc.setLocalDescription(offer);

      log('start: step 7/7 POST offer to OpenAI');
      const ans = await fetch('https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17', {
        method:'POST',
        headers:{ Authorization:`Bearer ${session.client_secret.value}`, 'Content-Type':'application/sdp' },
        body: offer.sdp
      }).then(r=>r.text());

      await pc.setRemoteDescription({ type:'answer', sdp: ans });
      setStatus('listening');
      log('connected ✓ (speak, or tap Force reply)');
    } catch (e) {
      setStatus('idle'); log('start error: '+(e?.message||e));
    }
  };

  document.getElementById('stop').onclick = () => {
    setStatus('idle'); log('stopping…');
    try { dc && dc.close(); } catch {}
    try { pc && pc.close(); } catch {}
    try { micTrack && micTrack.stop(); } catch {}
  };
})();
</script>
</body>
</html>
