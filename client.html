<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Voice Agent — Memory + Realtime (fixed audio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { font-size: 28px; margin-bottom: 16px; }
    .card { background:#f2f2f2; padding:16px; border-radius:12px; margin:12px 0; }
    .row { margin: 10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input { flex:1; min-width:220px; padding:12px; font-size:16px; border-radius:10px; border:1px solid #ccc; }
    button { padding:12px 16px; border-radius:12px; border:0; background:#e6e6e6; font-size:18px; }
    .ok { color: #0a8a00; font-weight:600; }
    .err { color: #b00020; font-weight:600; }
    pre { white-space: pre-wrap; background:#fafafa; padding:12px; border-radius:12px; border:1px solid #eee; max-height:40vh; overflow:auto; }
    small.mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Voice Agent — Memory + Realtime</h1>

  <div class="card">
    <div class="row"><b>Your Memory (saved to server)</b></div>
    <div class="row"><small class="mono">User ID: <span id="uid"></span></small>
      <button id="copyUid">Copy</button></div>

    <div class="row"><b>Name:</b><input id="name" placeholder="e.g., Roman" /><button id="saveName">Save</button><span id="saveNameStat"></span></div>
    <div class="row"><b>Kids:</b><input id="kids" placeholder="Comma-separated: Ava, Ben, Chris" /><button id="saveKids">Save</button><span id="saveKidsStat"></span></div>
    <div class="row"><b>Tone:</b><input id="tone" placeholder="e.g., witty, concise, encouraging" /><button id="saveTone">Save</button><span id="saveToneStat"></span></div>
    <div class="row"><b>Persona:</b><input id="persona" placeholder="e.g., friendly coach, upbeat coworker" /><button id="savePersona">Save</button><span id="savePersonaStat"></span></div>
  </div>

  <div class="row">
    <button id="beep1">Beep (WebAudio)</button>
    <button id="beep2">Beep (AudioTag)</button>
    <button id="unlock">Unlock mic</button>
  </div>

  <div class="row">
    <button id="start">Start voice agent</button>
    <button id="force" disabled>Force reply</button>
    <button id="stop" disabled>Stop</button>
  </div>

  <div class="row"><b>Status:</b> <span id="status">idle</span></div>
  <pre id="log"></pre>

  <!-- IMPORTANT: this plays the remote audio -->
  <audio id="remoteAudio" autoplay playsinline></audio>

<script>
const $ = (id) => document.getElementById(id);
const log = (s) => { $("log").textContent += (s + "\n"); $("log").scrollTop = $("log").scrollHeight; };
const setStatus = (s) => $("status").textContent = s;

// Stable userId (localStorage); keeps your memory consistent
function getUserId() {
  let id = localStorage.getItem("dummy_user_id");
  if (!id) { id = crypto.randomUUID(); localStorage.setItem("dummy_user_id", id); }
  return id;
}
const userId = getUserId();
$("uid").textContent = userId;
$("copyUid").onclick = () => navigator.clipboard.writeText(userId);

// ----- Memory UI -----
async function loadMemory() {
  try {
    const r = await fetch(`/memory/get?userId=${encodeURIComponent(userId)}`);
    const j = await r.json();
    const m = j.memory || {};
    $("name").value    = m.name    || "";
    $("kids").value    = m.kids    || "";
    $("tone").value    = m.tone    || "";
    $("persona").value = m.persona || "";
  } catch {}
}
async function setMem(key, value, el) {
  try {
    const r = await fetch(`/memory/set?userId=${encodeURIComponent(userId)}&key=${encodeURIComponent(key)}&value=${encodeURIComponent(value)}`);
    const j = await r.json();
    el.className = j.ok ? "ok" : "err";
    el.textContent = j.ok ? "Saved ✓" : "Failed";
    setTimeout(()=>{ el.textContent = ""; el.className=""; }, 2000);
  } catch { el.className="err"; el.textContent="Failed"; }
}
$("saveName").onclick    = () => setMem("name", $("name").value.trim(), $("saveNameStat"));
$("saveKids").onclick    = () => setMem("kids", $("kids").value.trim(), $("saveKidsStat"));
$("saveTone").onclick    = () => setMem("tone", $("tone").value.trim(), $("saveToneStat"));
$("savePersona").onclick = () => setMem("persona", $("persona").value.trim(), $("savePersonaStat"));

// ----- Audio nudges -----
$("beep1").onclick = () => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator(); const g = ctx.createGain();
  osc.frequency.value = 880; g.gain.value = 0.06;
  osc.connect(g).connect(ctx.destination); osc.start();
  setTimeout(()=>{ osc.stop(); ctx.close(); }, 150);
  log("WebAudio beep");
};
$("beep2").onclick = () => {
  const a = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA");
  a.play(); log("AudioTag beep");
};

// ----- Realtime (WebRTC) -----
let pc, dc, micStream;
const remoteAudio = $("remoteAudio");

$("unlock").onclick = async () => {
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    log("microphone OK");
  } catch (e) { log("mic error: " + e); }
};

$("start").onclick = async () => {
  setStatus("starting…"); $("force").disabled = true; $("stop").disabled = false;

  try {
    if (!micStream) micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // 1) Get ephemeral client_secret + personalized instructions
    log("start: step 3/7 fetch /session");
    const sres = await fetch(`/session?userId=${encodeURIComponent(userId)}`);
    const session = await sres.json();
    if (!session?.client_secret?.value) throw new Error("No client_secret in /session");
    log("start: got session");

    // 2) RTCPeerConnection
    log("start: step 5/7 create RTCPeerConnection");
    pc = new RTCPeerConnection();

    // ATTACH REMOTE AUDIO (this was missing before!)
    pc.ontrack = (ev) => {
      remoteAudio.srcObject = ev.streams[0];
      log("ontrack: remote audio attached");
    };

    // data channel
    dc = pc.createDataChannel("oai-events");
    dc.onopen = () => { $("force").disabled = false; log("datachannel open"); };
    dc.onmessage = (e) => { log("event: " + e.data.slice(0, 300)); };

    // send mic
    micStream.getTracks().forEach(t => pc.addTrack(t, micStream));

    // 3) Offer → OpenAI
    log("start: step 6/7 createOffer & setLocalDescription");
    const offer = await pc.createOffer({ offerToReceiveAudio: true });
    await pc.setLocalDescription(offer);

    log("start: step 7/7 POST offer to OpenAI");
    const resp = await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(session.model)}&voice=verse`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${session.client_secret.value}`,
        "Content-Type": "application/sdp"
      },
      body: offer.sdp
    });

    const answer = { type: "answer", sdp: await resp.text() };
    await pc.setRemoteDescription(answer);

    pc.oniceconnectionstatechange = () => log("pc state: " + pc.iceConnectionState);
    pc.onconnectionstatechange = () => log("ice state: " + pc.connectionState);

    setStatus("listening");
    log("connected ✓ (speak, or tap Force reply)");
  } catch (e) {
    setStatus("idle"); $("force").disabled = true; $("stop").disabled = true;
    log("start error: " + e);
  }
};

$("force").onclick = () => {
  try {
    if (!dc || dc.readyState !== "open") { log("force: datachannel not open"); return; }

    // Be explicit: ask for an audio reply so we hear something immediately
    const name = $("name").value.trim();
    const greet = name ? `Say: Hello ${name}. I can hear you.` : "Say: Hello. I can hear you.";

    dc.send(JSON.stringify({
      type: "response.create",
      response: { modalities: ["audio"], instructions: greet }
    }));

    log("force: sent response.create");
  } catch (e) { log("force error: " + e); }
};

$("stop").onclick = () => {
  try {
    if (dc) dc.close();
    if (pc) pc.close();
    dc = null; pc = null;
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    remoteAudio.srcObject = null;
    $("force").disabled = true; $("stop").disabled = true;
    setStatus("idle");
    log("stopped");
  } catch {}
};

// Boot
loadMemory();
</script>
</body>
</html>
